---
title: "PCoA Visuals and Statistics for VOC collections"
output: html_notebook
---

*This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*. When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file). The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed. Packages and libraries necessary to complete data analysis.Please consult the appropriate documentation for a comprehensive review of each package's capabilities.* 

### General
### Specific
### Purpose/Gap
### Describe Analysis
### Implication
```{r setup, include=TRUE}
######################################################
#Loads libraries necessary to use phyloseq package ###
######################################################

knitr::opts_chunk$set(
	message = TRUE,
	warning = TRUE,
	include = FALSE
)
# Libraries and Data Frames
##what you need to install phyloseq
#source('http://bioconductor.org/biocLite.R')
#biocLite('phyloseq')
#install.packages("devtools")
#install_github("vqv/ggbiplot")
#install.packages("gdata")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
#BiocManager::install()
library(gdata)
library(devtools)
library(ggplot2)
library(beeswarm)
library(phyloseq) #install via bioconductor
library(vegan) 
library(ggbiplot)
library(readxl)
library(readr)
library(ape)
library(DESeq2)
```


### Group "1" Dataset: all of the samples (SPME Blanks, Process Blanks, and Treatments) from the VOC collections
```{r}
###################################################################
## Organizing the datatables to be compatiable with the phyloseq.## 
###################################################################

meta <- read.csv("/Users/jbrown/Documents/GitHub/BACandBlue/data/BACandSTRAW_SUBSET_SWDvsSBERRY_BLANK_PRO_REP/meta1.csv") 
meta$hour=as.factor(meta$hour)
rownames(meta) <- meta$SampleID_merge 
SAMP <- sample_data(meta)
sample_names(SAMP)<-meta$SampleID

peaks <- read.csv("/Users/jbrown/Documents/GitHub/BACandBlue/data/BACandSTRAW_SUBSET_SWDvsSBERRY_BLANK_PRO_REP/peak1.csv")
TAX <- tax_table(peaks) # gives a warning, don't freak out
taxa_names(TAX)<-peaks$Peak_ID
colnames(TAX)<- colnames(peaks)

abund <- read.csv("/Users/jbrown/Documents/GitHub/BACandBlue/data/BACandSTRAW_SUBSET_SWDvsSBERRY_BLANK_PRO_REP/otu1.csv", colClasses = c("factor","factor", rep("numeric", times= 14)))
# read in peak areas, assigning factors of diff classifications based on columns
rownames(abund) <- abund$Peak_ID #give abund rows names according to "Peak_ID" in peak.csv table
OTU <- otu_table(abund[,-c(1:2)], taxa_are_rows=T) #create a table with only peak areas, compounds are taxa


VOC <- phyloseq(OTU, TAX, SAMP) #IF YOU GET A "SAMPLE_NAMES()" ERROR MAKE SURE YOUR NAMES DO NOT START WITH A NUMBER

#returns: "phyloseq-class experiment-level object
#otu_table()   OTU Table:       [ 77 taxa and 14 samples ] "taxa" = VOCs "samples" = SPME-HS samples
#sample_data() Sample Data:     [ 14 samples by 9 sample variables ] "sample variable" = categories
#tax_table()   Taxonomy Table:  [ 77 taxa by 2 taxonomic ranks ] "taxonomic rank" = sample time/hour"
```

### Visualizing OTUs
```{r}
#############################
#Bray-Curtis Distances PCoAs#
#############################

ord <- ordinate(VOC, method = "PCoA", distance = "bray")
plot_ordination(VOC, ord, color = "hour", shape = "microbe", label = "rep")+
  theme_bw() + theme(text = element_text(size = 20)) + geom_point(size = 4)
plot_ordination(VOC, ord, type = "juice", color = "hour", shape = "microbe", label = "rep")+
  theme_bw() + theme(text = element_text(size = 20)) + geom_point(size = 4)

PCs <- data.frame(scores(ord$vectors))
new.dat <- cbind(PCs, sample_data(VOC)$microbe, sample_data(VOC)$rep, sample_data(VOC)$hour) # make a new matrix
names(new.dat)[12:14] <- c("Microbe","Rep","Hour") #for the "must be the same length as vector" error make sure that the info inside the bracets matches empty columns in the dataframe your creating"
library(gdata)
new.dat$Microbe <- reorder.factor(new.dat$Microbe, new.order = c("SWD"))
new.dat$Hour <- reorder.factor(new.dat$Hour, new.order = c("24","48"))

summary(new.dat)

ggplot(new.dat, aes(x=Axis.1, y= Axis.2)) +
  geom_point(aes(color = Hour, shape = Rep), position ="jitter") +
  #facet_grid(~Hour)+
  theme_bw()+
  xlab("PCoA1 (59.1% Var. Expl.)")+ 	## !don't forget to update these moving forward!
  ylab("PCoA2 (32.6% Var. Expl.)")


#########################
#Jaccard distances PCoAs#
#########################

ord <- ordinate(VOC, method = "PCoA", distance = "jaccard")
plot_ordination( VOC, ord, color = "hour", shape = "microbe", type = "samples")
# split plot of compounds driving separation and samples in PC1/PC2. 
plot_ordination(VOC, ord, type = "samples", color = "hour", shape = "microbe", label = "rep")
###
###
PCs <- data.frame(scores(ord$vectors))
new.dat <- cbind(PCs, sample_data(VOC)$microbe, sample_data(VOC)$hour, sample_data(VOC)$rep) # make a new matrix
names(new.dat)[13:15] <- c("Microbe", "Hour", "Rep")
library(gdata)
new.dat$Microbe <- reorder.factor(new.dat$Microbe, new.order = c("SWD"))
new.dat$Hour <- reorder.factor(new.dat$Hour, new.order = c("24", "48"))
###
###
ggplot(new.dat, aes(x=Axis.1, y= Axis.2)) +
  geom_point(aes(color = Rep, shape = Hour), position ="jitter") +
  facet_grid(~Hour)+
  theme_bw()+
  xlab("PCoA1 (78.6% Var. Expl.)")+ 
  ylab("PCoA2 (13.8% Var. Expl.)")
```



